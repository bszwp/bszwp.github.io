---
layout: post
title: "gulp的使用方法与个人心得"
date: 2017-01-07
description: "gulp的使用方法与个人心得"
tag: 自动构建 
---

[TOC]

### 1. 安装node.js

> Node.js 是一个基于 Chrome V8 引擎的 JavaScript 运行环境。 
> Node.js 使用了一个事件驱动、非阻塞式 I/O 的模型，使其轻量又高效。 
>
> 下载地址 http://nodejs.cn/
>
> 检测是否安装成功 ` node -v`

### 2. npm包管理工具

> Node.js 的包管理器 npm，是全球最大的开源库生态系统。
>
> 简称npm版本
>
> `npm -v`

### 3. 安装Gulp

> 1) 在全局安装gulp
>
>  `npm install -g gulp`
>
> 2) 在局部安装gulp
>  `npm install gulp --save-dev`
> 3) 检测Gulp是否安装成功
>  `gulp -v`

> - 全局安装是为了使用gulp的命令
> - 局部安装是为了使用gulp的插件

### 4. 初始化项目

> `npm init`
>
> 输入对应的项目信息
>
> 自动生成package.json文件

```json
{
  "name": "myapp",
  "version": "1.0.0",
  "description": "test",
  //入口文件，配置为gulpfile.js
  "main": "gulpfile.js",
  "scripts": {
    "test": "echo \"Error: no test specified\" && exit 1"
  },
  "author": "quanzaiyu",
  "license": "ISC",
  //插件列表
  "devDependencies": {
    "gulp": "^3.9.1",
    "gulp-clean-css": "^2.3.0",
    "gulp-concat": "^2.6.1",
    "gulp-css-spriter": "^0.3.3",
    "gulp-htmlmin": "^3.0.0",
    "gulp-imagemin": "^3.1.1",
    "gulp-less": "^3.3.0",
    "gulp-livereload": "^3.8.1",
    "gulp-minify-css": "^1.2.4",
    "gulp-obfuscate": "^0.2.9",
    "gulp-postcss": "^6.3.0",
    "gulp-uglify": "^2.0.0"
  }
}
```

> 如果之前已经配置过package.json，则输入`npm install`即可安装dependencies指定的所有包

### 5. 安装gulp插件

> 如: `npm install gulp-less --save-dev`

### 6. 创建项目结构

> dev	为开发目录
>
> dist	为发布目录

### 7. 在当前项目中创建gulpfile.js文件

#### 7.1 引入gulp模块

```javascript
var gulp = require('gulp');
```

#### 7.2 引入插件模块

```javascript
var less = require('gulp-less');
```

#### 7.3 使用插件

```javascript
// 使用gulp.task创建一个任务
// 第一个参数是任务名称，第二个参数是一个回调函数
gulp.task('less', function () {
	var lesses = [
		'dev/less/*.less'
	];
  	// gulp.src指定源文件
  	// gulp.pipe用于连接使用插件
  	// gulp.dest指定输出的目标地址
  	return gulp.src(lesses)
		.pipe(less())
		.pipe(gulp.dest('dev/css'));
});
```

> 在命令行中输入`gulp less`即可执行相应命令

#### 7.4 合并执行、依赖执行

```javascript
// 可以在任务名称和回调函数之间指定一个数组，必须在指定数组内的任务执行完毕之后才执行回调函数
gulp.task('compressCss',['compileLess'],function () {
	//压缩css
	gulp.src('public/css/*.css')
		.pipe(minify())
		.pipe(gulp.dest('dist/css'));
});
```

#### 7.5 默认任务

> 默认任务default，保证数组中所有的任务执行完毕之后才执行function
>
> 在命令行中输入 `gulp` 即可执行默认任务

```javascript
gulp.task('default',['compressCss','compressJs','compressHtml']);
```

#### 7.6 自动执行

> 监听文件改动，自动编译
>
> 执行`gulp watch`监听文件的变动，此时不要关闭命令行

```javascript
gulp.task('autorun',function () {
	gulp.watch(['public/less/*.less','public/js/*.js'],function () {
			//编译less
			gulp.src('public/less/*.less')
				.pipe(less())
				.pipe(gulp.dest('public/css'));
			//压缩js
			gulp.src('public/js/*.js')
				.pipe(uglify())
				.pipe(gulp.dest('dist/js'));
	});
})
```

### 完整代码

```javascript
//引入gulp模块
var gulp = require('gulp');
//引入gulp-less模块(编译less)
var less = require('gulp-less');
//引入gulp-minify-css模块(压缩css)
var minify = require('gulp-minify-css');
//引入gulp-uglify模块(压缩js)
var uglify = require('gulp-uglify');
//引入gulp-imagemin(图片压缩)
var imagemin = require('gulp-imagemin');
//引入gulp-concat(资源合并)
var concat = require('gulp-concat');
//引入gulp-obfuscate(代码混淆)
var obfuscate = require('gulp-obfuscate');
//引入gulp-htmlmin(压缩html)
var htmlmin = require('gulp-htmlmin');
//引入gulp-css-spriter(合并精灵图)
var spriter = require('gulp-css-spriter');

//gulp 有几个常用方法
//--task	任务
//--src		引入
//--pipe	管道
//--dest	目标

//发起一个任务，用于编译less
//task(a,b,c)
//--a.任务名称
//--b.执行依赖，可省略
//--c.回调函数，可添加依赖省略回调函数

//1. src引入文件路径
//2. 利用pipe执行less和minify操作
//3. 利用pipe将编译好的文件放到指定路径
//	dest指定编译后生成文件的目标路径

gulp.task('compileLess',function () {
	//编译less
	gulp.src('public/less/*.less')
		.pipe(less())
		.pipe(gulp.dest('public/css'));
});

gulp.task('compressCss',['compileLess'],function () {
	//压缩css
	gulp.src('public/css/*.css')
		.pipe(minify())
		.pipe(gulp.dest('dist/css'));
});

gulp.task('compressJs',function () {
	//压缩js
	gulp.src('public/js/*.js')
		.pipe(uglify())
		.pipe(gulp.dest('dist/js'));
});

gulp.task('compressHtml',function () {
	//压缩html
	var options = {
		removeComments: true,//清除HTML注释
		collapseWhitespace: true,//压缩HTML
		collapseBooleanAttributes: true,//省略布尔属性的值
		removeEmptyAttributes: true,//删除所有空格作属性值
		removeScriptTypeAttributes: true,//删除script标签中的属性
		removeStyleLinkTypeAttributes: true,//删除style和link标签中的属性
		minifyJS: true,//压缩页面JS
		minifyCSS: true//压缩页面CSS
	}
	gulp.src('public/index.html')
		.pipe(htmlmin(options))
		.pipe(gulp.dest('dist'));
});

gulp.task('compressImage',function () {
	//压缩图片
	gulp.src('public/img/*.png')
		.pipe(imagemin())
		.pipe(gulp.dest('dist/img'));
});

gulp.task('concatCss',function () {
	//合并并压缩css
	gulp.src('dist/css/*.css')
		.pipe(concat('all.min.css'))
		.pipe(minify())
		.pipe(gulp.dest('dist/css'));
});

gulp.task('concatJs',function () {
	//合并并压缩js
	gulp.src('dist/js/*.js')
		.pipe(concat('all.min.js'))
		.pipe(uglify())
		.pipe(gulp.dest('dist/js'));
});

//在命令行中输入gulp xxx执行对应的的任务

//合并执行
//默认任务default，保证数组中所有的任务执行完毕之后才执行function
gulp.task('default',['compressCss','compressJs','compressHtml']);

//在命令行中输入gulp 执行默认任务

//监听文件改动，自动编译
gulp.task('autorun',function () {
	gulp.watch(['public/less/*.less','public/js/*.js'],function () {
			//编译less
			gulp.src('public/less/*.less')
				.pipe(less())
				.pipe(gulp.dest('public/css'));
			//压缩js
			gulp.src('public/js/*.js')
				.pipe(uglify())
				.pipe(gulp.dest('dist/js'));
	});
})

//执行gulp watch监听文件的变动
//此时不要关闭命令行
```



### 常用的gulp插件

#### gulp-clean-css

css压缩

#### gulp-concat

资源合并

#### gulp-css-spriter

CSS图片精灵

```javascript
var gulp = require('gulp');
var spriter = require('gulp-css-spriter');
 
gulp.task('css', function() {
    return gulp.src('./css/recharge.css')//比如recharge.css这个样式里面什么都不用改，是你想要合并的图就要引用这个样式。 很重要 注意(recharge.css)这个是我的项目。别傻到家抄我一样的。
        .pipe(spriter({
            // The path and file name of where we will save the sprite sheet
            'spriteSheet': './dist/images/spritesheet.png', //这是雪碧图自动合成的图。 很重要
            // Because we don't know where you will end up saving the CSS file at this point in the pipe,
            // we need a litle help identifying where it will be.
            'pathToSpriteSheetFromCSS': '../images/spritesheet.png' //这是在css引用的图片路径，很重要
        }))
        .pipe(gulp.dest('./dist/css')); //最后生成出来
});
```

#### gulp-htmlmin

压缩html

- 选项

  removeComments: true,//清除HTML注释
  collapseWhitespace: true,//压缩HTML
  collapseBooleanAttributes: true,//省略布尔属性的值
  removeEmptyAttributes: true,//删除所有空格作属性值
  removeScriptTypeAttributes: true,//删除script标签中的属性
  removeStyleLinkTypeAttributes: true,//删除style和link标签中的属性
  minifyJS: true,//压缩页面JS
  minifyCSS: true//压缩页面CSS
#### gulp-imagemin

图片压缩

#### gulp-less

less编译

#### gulp-livereload

自动刷新

#### gulp-minify-css

css压缩

#### gulp-obfuscate

代码混淆

#### gulp-uglify

js压缩

#### gulp-postcss

px转化为rem

> 详情查看 https://www.npmjs.com/